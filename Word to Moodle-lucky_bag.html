<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Question Bags</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js">
    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.convertToHtml({arrayBuffer});
            console.log("Converted HTML:", result.value);
            parseQuestions(result.value);
            
            if (questions.length > 0) {
                document.getElementById('totalCount').textContent = questions.length;
                resetGame();
                alert(`ƒê√£ t·∫£i th√†nh c√¥ng ${questions.length} c√¢u h·ªèi!`);
            } else {
                alert('Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong file!');
            }
        } catch (error) {
            console.error("Error:", error);
            alert('L·ªói khi ƒë·ªçc file: ' + error.message);
        }
    }

    function parseQuestions(html) {
        questions = [];
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const paragraphs = doc.body.querySelectorAll('p');
            
            let currentQuestion = null;
            let options = [];
            let correctIndex = -1;

            paragraphs.forEach(p => {
                const text = p.innerHTML.trim();
                let questionMatch = text.match(/C√¢u\s*\d+\s*[.:]/);
                
                if (questionMatch) {
                    if (currentQuestion && options.length === 4 && correctIndex !== -1) {
                        questions.push({
                            question: currentQuestion,
                            options: options,
                            correct: correctIndex
                        });
                    }
                    currentQuestion = text;
                    options = [];
                    correctIndex = -1;
                } else if (currentQuestion) {
                    let optionMatch = text.match(/([A-D])\s*[.)]/);
                    if (optionMatch) {
                        const optionLabel = optionMatch[1];
                        const optionText = text;
                        options.push(optionText);
                        if (text.includes('#')) {
                            correctIndex = optionLabel.charCodeAt(0) - 'A'.charCodeAt(0);
                        }
                    }
                }
            });

            if (currentQuestion && options.length === 4 && correctIndex !== -1) {
                questions.push({
                    question: currentQuestion,
                    options: options,
                    correct: correctIndex
                });
            }
        } catch (error) {
            console.error("Parse error:", error);
            throw error;
        }
    }

    function createBags() {
        const container = document.getElementById('bagsContainer');
        container.innerHTML = '';
        
        for (let i = 0; i < questions.length; i++) {
            const bag = document.createElement('div');
            bag.className = 'question-bag';
            bag.innerHTML = `
                <div class="heart-shape"></div>
                <div class="bag-number">${i + 1}</div>
            `;
            
            bag.onclick = () => {
                if (!gameState.openedBags.has(i)) {
                    openQuestion(i);
                    gameState.openedBags.add(i);
                    bag.style.opacity = '0.6';
                    bag.style.cursor = 'default';
                }
            };
            
            container.appendChild(bag);
        }
        
        updateScoreBoard();
    }

    function openQuestion(index) {
        const questionData = questions[index];
        const modal = document.getElementById('questionModal');
        const questionText = modal.querySelector('.question-text');
        const optionsContainer = modal.querySelector('.options-container');
        const answerButton = modal.querySelector('.answer-button');
        const resultMessage = modal.querySelector('.result-message');
        
        questionText.innerHTML = questionData.question;
        optionsContainer.innerHTML = '';
        resultMessage.style.display = 'none';
        answerButton.disabled = false;
        
        questionData.options.forEach((option, i) => {
            const id = `option-${index}-${i}`;
            optionsContainer.innerHTML += `
                <div class="option-wrapper">
                    <input type="radio" name="answer" value="${i}" id="${id}" class="option-input">
                    <label for="${id}" class="option-label">
                        <div class="option-radio"></div>
                        <div class="option-text">${option}</div>
                    </label>
                </div>
            `;
        });

        answerButton.onclick = () => {
            const selectedOption = modal.querySelector('input[name="answer"]:checked');
            if (!selectedOption) {
                alert('Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n!');
                return;
            }

            const isCorrect = parseInt(selectedOption.value) === questionData.correct;
            
            gameState.score += isCorrect ? 1 : 0;
            gameState.correctCount += isCorrect ? 1 : 0;
            gameState.totalAnswered += 1;

            if (isCorrect) {
                showCorrectAnswer();
                createConfetti();
            } else {
                showIncorrectAnswer();
            }

            answerButton.disabled = true;
            
            const labels = optionsContainer.querySelectorAll('.option-label');
            labels[questionData.correct].style.backgroundColor = '#90EE90';
            
            if (!isCorrect) {
                labels[parseInt(selectedOption.value)].style.backgroundColor = '#FFB6C1';
            }
            
            updateScoreBoard();
        };

        modal.style.display = 'flex';
        MathJax.typesetPromise && MathJax.typesetPromise();
    }

    function showCorrectAnswer() {
        showMessage('result-correct',
            'üéâ',
            'Ch√≠nh x√°c! B·∫°n th·∫≠t xu·∫•t s·∫Øc!<br>H√£y ti·∫øp t·ª•c ph√°t huy nh√©! üåü'
        );
    }

    function showIncorrectAnswer() {
        showMessage('result-incorrect',
            'üòî',
            'R·∫•t ti·∫øc, c√¢u tr·∫£ l·ªùi ch∆∞a ch√≠nh x√°c.<br>ƒê·ª´ng n·∫£n ch√≠, h√£y c·ªë g·∫Øng ·ªü c√¢u ti·∫øp theo nh√©! üí™'
        );
    }

    function showMessage(className, icon, message) {
        const resultMessage = document.querySelector('.result-message');
        resultMessage.className = 'result-message ' + className;
        resultMessage.innerHTML = `
            <div class="result-icon">${icon}</div>
            <div>${message}</div>
        `;
        resultMessage.style.display = 'block';
    }

    function createConfetti() {
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
        
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.animationDelay = Math.random() * 3 + 's';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            document.body.appendChild(confetti);

            setTimeout(() => confetti.remove(), 3000);
        }
    }

    function updateScoreBoard() {
        document.getElementById('score').textContent = gameState.score;
        document.getElementById('correctCount').textContent = gameState.correctCount;
        document.getElementById('totalCount').textContent = gameState.totalAnswered;
    }

    function resetGame() {
        gameState = {
            score: 0,
            correctCount: 0,
            totalAnswered: 0,
            openedBags: new Set()
        };
        questions = questions.sort(() => Math.random() - 0.5);
        createBags();
        updateScoreBoard();
    }

    document.getElementById('fileInput').addEventListener('change', handleFileSelect);

    const modal = document.getElementById('questionModal');
    const closeButton = document.querySelector('.close-button');

    closeButton.onclick = () => modal.style.display = 'none';
    window.onclick = (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };

    // Initialize game
    createBags();
</script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6">
    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.convertToHtml({arrayBuffer});
            console.log("Converted HTML:", result.value);
            parseQuestions(result.value);
            
            if (questions.length > 0) {
                document.getElementById('totalCount').textContent = questions.length;
                resetGame();
                alert(`ƒê√£ t·∫£i th√†nh c√¥ng ${questions.length} c√¢u h·ªèi!`);
            } else {
                alert('Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong file!');
            }
        } catch (error) {
            console.error("Error:", error);
            alert('L·ªói khi ƒë·ªçc file: ' + error.message);
        }
    }

    function parseQuestions(html) {
        questions = [];
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const paragraphs = doc.body.querySelectorAll('p');
            
            let currentQuestion = null;
            let options = [];
            let correctIndex = -1;

            paragraphs.forEach(p => {
                const text = p.innerHTML.trim();
                let questionMatch = text.match(/C√¢u\s*\d+\s*[.:]/);
                
                if (questionMatch) {
                    if (currentQuestion && options.length === 4 && correctIndex !== -1) {
                        questions.push({
                            question: currentQuestion,
                            options: options,
                            correct: correctIndex
                        });
                    }
                    currentQuestion = text;
                    options = [];
                    correctIndex = -1;
                } else if (currentQuestion) {
                    let optionMatch = text.match(/([A-D])\s*[.)]/);
                    if (optionMatch) {
                        const optionLabel = optionMatch[1];
                        const optionText = text;
                        options.push(optionText);
                        if (text.includes('#')) {
                            correctIndex = optionLabel.charCodeAt(0) - 'A'.charCodeAt(0);
                        }
                    }
                }
            });

            if (currentQuestion && options.length === 4 && correctIndex !== -1) {
                questions.push({
                    question: currentQuestion,
                    options: options,
                    correct: correctIndex
                });
            }
        } catch (error) {
            console.error("Parse error:", error);
            throw error;
        }
    }

    function createBags() {
        const container = document.getElementById('bagsContainer');
        container.innerHTML = '';
        
        for (let i = 0; i < questions.length; i++) {
            const bag = document.createElement('div');
            bag.className = 'question-bag';
            bag.innerHTML = `
                <div class="heart-shape"></div>
                <div class="bag-number">${i + 1}</div>
            `;
            
            bag.onclick = () => {
                if (!gameState.openedBags.has(i)) {
                    openQuestion(i);
                    gameState.openedBags.add(i);
                    bag.style.opacity = '0.6';
                    bag.style.cursor = 'default';
                }
            };
            
            container.appendChild(bag);
        }
        
        updateScoreBoard();
    }

    function openQuestion(index) {
        const questionData = questions[index];
        const modal = document.getElementById('questionModal');
        const questionText = modal.querySelector('.question-text');
        const optionsContainer = modal.querySelector('.options-container');
        const answerButton = modal.querySelector('.answer-button');
        const resultMessage = modal.querySelector('.result-message');
        
        questionText.innerHTML = questionData.question;
        optionsContainer.innerHTML = '';
        resultMessage.style.display = 'none';
        answerButton.disabled = false;
        
        questionData.options.forEach((option, i) => {
            const id = `option-${index}-${i}`;
            optionsContainer.innerHTML += `
                <div class="option-wrapper">
                    <input type="radio" name="answer" value="${i}" id="${id}" class="option-input">
                    <label for="${id}" class="option-label">
                        <div class="option-radio"></div>
                        <div class="option-text">${option}</div>
                    </label>
                </div>
            `;
        });

        answerButton.onclick = () => {
            const selectedOption = modal.querySelector('input[name="answer"]:checked');
            if (!selectedOption) {
                alert('Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n!');
                return;
            }

            const isCorrect = parseInt(selectedOption.value) === questionData.correct;
            
            gameState.score += isCorrect ? 1 : 0;
            gameState.correctCount += isCorrect ? 1 : 0;
            gameState.totalAnswered += 1;

            if (isCorrect) {
                showCorrectAnswer();
                createConfetti();
            } else {
                showIncorrectAnswer();
            }

            answerButton.disabled = true;
            
            const labels = optionsContainer.querySelectorAll('.option-label');
            labels[questionData.correct].style.backgroundColor = '#90EE90';
            
            if (!isCorrect) {
                labels[parseInt(selectedOption.value)].style.backgroundColor = '#FFB6C1';
            }
            
            updateScoreBoard();
        };

        modal.style.display = 'flex';
        MathJax.typesetPromise && MathJax.typesetPromise();
    }

    function showCorrectAnswer() {
        showMessage('result-correct',
            'üéâ',
            'Ch√≠nh x√°c! B·∫°n th·∫≠t xu·∫•t s·∫Øc!<br>H√£y ti·∫øp t·ª•c ph√°t huy nh√©! üåü'
        );
    }

    function showIncorrectAnswer() {
        showMessage('result-incorrect',
            'üòî',
            'R·∫•t ti·∫øc, c√¢u tr·∫£ l·ªùi ch∆∞a ch√≠nh x√°c.<br>ƒê·ª´ng n·∫£n ch√≠, h√£y c·ªë g·∫Øng ·ªü c√¢u ti·∫øp theo nh√©! üí™'
        );
    }

    function showMessage(className, icon, message) {
        const resultMessage = document.querySelector('.result-message');
        resultMessage.className = 'result-message ' + className;
        resultMessage.innerHTML = `
            <div class="result-icon">${icon}</div>
            <div>${message}</div>
        `;
        resultMessage.style.display = 'block';
    }

    function createConfetti() {
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
        
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.animationDelay = Math.random() * 3 + 's';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            document.body.appendChild(confetti);

            setTimeout(() => confetti.remove(), 3000);
        }
    }

    function updateScoreBoard() {
        document.getElementById('score').textContent = gameState.score;
        document.getElementById('correctCount').textContent = gameState.correctCount;
        document.getElementById('totalCount').textContent = gameState.totalAnswered;
    }

    function resetGame() {
        gameState = {
            score: 0,
            correctCount: 0,
            totalAnswered: 0,
            openedBags: new Set()
        };
        questions = questions.sort(() => Math.random() - 0.5);
        createBags();
        updateScoreBoard();
    }

    document.getElementById('fileInput').addEventListener('change', handleFileSelect);

    const modal = document.getElementById('questionModal');
    const closeButton = document.querySelector('.close-button');

    closeButton.onclick = () => modal.style.display = 'none';
    window.onclick = (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };

    // Initialize game
    createBags();
</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.convertToHtml({arrayBuffer});
            console.log("Converted HTML:", result.value);
            parseQuestions(result.value);
            
            if (questions.length > 0) {
                document.getElementById('totalCount').textContent = questions.length;
                resetGame();
                alert(`ƒê√£ t·∫£i th√†nh c√¥ng ${questions.length} c√¢u h·ªèi!`);
            } else {
                alert('Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong file!');
            }
        } catch (error) {
            console.error("Error:", error);
            alert('L·ªói khi ƒë·ªçc file: ' + error.message);
        }
    }

    function parseQuestions(html) {
        questions = [];
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const paragraphs = doc.body.querySelectorAll('p');
            
            let currentQuestion = null;
            let options = [];
            let correctIndex = -1;

            paragraphs.forEach(p => {
                const text = p.innerHTML.trim();
                let questionMatch = text.match(/C√¢u\s*\d+\s*[.:]/);
                
                if (questionMatch) {
                    if (currentQuestion && options.length === 4 && correctIndex !== -1) {
                        questions.push({
                            question: currentQuestion,
                            options: options,
                            correct: correctIndex
                        });
                    }
                    currentQuestion = text;
                    options = [];
                    correctIndex = -1;
                } else if (currentQuestion) {
                    let optionMatch = text.match(/([A-D])\s*[.)]/);
                    if (optionMatch) {
                        const optionLabel = optionMatch[1];
                        const optionText = text;
                        options.push(optionText);
                        if (text.includes('#')) {
                            correctIndex = optionLabel.charCodeAt(0) - 'A'.charCodeAt(0);
                        }
                    }
                }
            });

            if (currentQuestion && options.length === 4 && correctIndex !== -1) {
                questions.push({
                    question: currentQuestion,
                    options: options,
                    correct: correctIndex
                });
            }
        } catch (error) {
            console.error("Parse error:", error);
            throw error;
        }
    }

    function createBags() {
        const container = document.getElementById('bagsContainer');
        container.innerHTML = '';
        
        for (let i = 0; i < questions.length; i++) {
            const bag = document.createElement('div');
            bag.className = 'question-bag';
            bag.innerHTML = `
                <div class="heart-shape"></div>
                <div class="bag-number">${i + 1}</div>
            `;
            
            bag.onclick = () => {
                if (!gameState.openedBags.has(i)) {
                    openQuestion(i);
                    gameState.openedBags.add(i);
                    bag.style.opacity = '0.6';
                    bag.style.cursor = 'default';
                }
            };
            
            container.appendChild(bag);
        }
        
        updateScoreBoard();
    }

    function openQuestion(index) {
        const questionData = questions[index];
        const modal = document.getElementById('questionModal');
        const questionText = modal.querySelector('.question-text');
        const optionsContainer = modal.querySelector('.options-container');
        const answerButton = modal.querySelector('.answer-button');
        const resultMessage = modal.querySelector('.result-message');
        
        questionText.innerHTML = questionData.question;
        optionsContainer.innerHTML = '';
        resultMessage.style.display = 'none';
        answerButton.disabled = false;
        
        questionData.options.forEach((option, i) => {
            const id = `option-${index}-${i}`;
            optionsContainer.innerHTML += `
                <div class="option-wrapper">
                    <input type="radio" name="answer" value="${i}" id="${id}" class="option-input">
                    <label for="${id}" class="option-label">
                        <div class="option-radio"></div>
                        <div class="option-text">${option}</div>
                    </label>
                </div>
            `;
        });

        answerButton.onclick = () => {
            const selectedOption = modal.querySelector('input[name="answer"]:checked');
            if (!selectedOption) {
                alert('Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n!');
                return;
            }

            const isCorrect = parseInt(selectedOption.value) === questionData.correct;
            
            gameState.score += isCorrect ? 1 : 0;
            gameState.correctCount += isCorrect ? 1 : 0;
            gameState.totalAnswered += 1;

            if (isCorrect) {
                showCorrectAnswer();
                createConfetti();
            } else {
                showIncorrectAnswer();
            }

            answerButton.disabled = true;
            
            const labels = optionsContainer.querySelectorAll('.option-label');
            labels[questionData.correct].style.backgroundColor = '#90EE90';
            
            if (!isCorrect) {
                labels[parseInt(selectedOption.value)].style.backgroundColor = '#FFB6C1';
            }
            
            updateScoreBoard();
        };

        modal.style.display = 'flex';
        MathJax.typesetPromise && MathJax.typesetPromise();
    }

    function showCorrectAnswer() {
        showMessage('result-correct',
            'üéâ',
            'Ch√≠nh x√°c! B·∫°n th·∫≠t xu·∫•t s·∫Øc!<br>H√£y ti·∫øp t·ª•c ph√°t huy nh√©! üåü'
        );
    }

    function showIncorrectAnswer() {
        showMessage('result-incorrect',
            'üòî',
            'R·∫•t ti·∫øc, c√¢u tr·∫£ l·ªùi ch∆∞a ch√≠nh x√°c.<br>ƒê·ª´ng n·∫£n ch√≠, h√£y c·ªë g·∫Øng ·ªü c√¢u ti·∫øp theo nh√©! üí™'
        );
    }

    function showMessage(className, icon, message) {
        const resultMessage = document.querySelector('.result-message');
        resultMessage.className = 'result-message ' + className;
        resultMessage.innerHTML = `
            <div class="result-icon">${icon}</div>
            <div>${message}</div>
        `;
        resultMessage.style.display = 'block';
    }

    function createConfetti() {
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
        
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.animationDelay = Math.random() * 3 + 's';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            document.body.appendChild(confetti);

            setTimeout(() => confetti.remove(), 3000);
        }
    }

    function updateScoreBoard() {
        document.getElementById('score').textContent = gameState.score;
        document.getElementById('correctCount').textContent = gameState.correctCount;
        document.getElementById('totalCount').textContent = gameState.totalAnswered;
    }

    function resetGame() {
        gameState = {
            score: 0,
            correctCount: 0,
            totalAnswered: 0,
            openedBags: new Set()
        };
        questions = questions.sort(() => Math.random() - 0.5);
        createBags();
        updateScoreBoard();
    }

    document.getElementById('fileInput').addEventListener('change', handleFileSelect);

    const modal = document.getElementById('questionModal');
    const closeButton = document.querySelector('.close-button');

    closeButton.onclick = () => modal.style.display = 'none';
    window.onclick = (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };

    // Initialize game
    createBags();
</script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin: 0;
            padding: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .score-board {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .score {
            font-size: 1.2em;
            font-weight: bold;
            color: #4a90e2;
        }

        .file-input {
            display: block;
            margin-bottom: 20px;
            padding: 10px;
            width: 100%;
            max-width: 300px;
        }

        .reset-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .reset-button:hover {
            background: #45a049;
        }

        .bags-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .question-bag {
            position: relative;
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .question-bag:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .heart-shape {
            position: relative;
            width: 80px;
            height: 80px;
            animation: pulse 1.5s ease infinite;
        }

        .heart-shape::before,
        .heart-shape::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 60px;
            background: #ff6b6b;
            border-radius: 40px 40px 0 0;
            transform-origin: bottom;
        }

        .heart-shape::before {
            left: 40px;
            transform: rotate(-45deg);
        }

        .heart-shape::after {
            left: 0;
            transform: rotate(45deg);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .bag-number {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #2c3e50;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalShow 0.3s ease;
        }

        @keyframes modalShow {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-card {
            background: linear-gradient(135deg, #0099ff 0%, #0077cc 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .question-text {
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-wrapper {
            margin-bottom: 10px;
        }

        .option-input {
            display: none;
        }

        .option-label {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
        }

        .option-label:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .option-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            margin-right: 15px;
            position: relative;
        }

        .option-input:checked + .option-label {
            background: #e3f2fd;
        }

        .option-input:checked + .option-label .option-radio::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: #0099ff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .close-button {
            position: absolute;
            right: 20px;
            top: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            color: #333;
            transform: rotate(90deg);
        }

        .answer-button {
            background: #4CAF50;
            color: white;
            border: none;
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .answer-button:hover {
            background: #45a049;
        }

        .answer-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .result-message {
            display: none;
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            border-radius: 10px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .result-correct {
            background: #4CAF50;
            color: white;
        }

        .result-incorrect {
            background: #f44336;
            color: white;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f44336;
            animation: confetti 3s ease-in-out infinite;
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotateZ(0); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1>üéÆ Lucky Question Bags</h1>
        </div>

        <div class="score-board">
            <div class="score">ƒêi·ªÉm: <span id="score">0</span></div>
            <div class="score">S·ªë c√¢u ƒë√∫ng: <span id="correctCount">0</span>/<span id="totalCount">0</span></div>
        </div>

        <input type="file" id="fileInput" accept=".docx" class="file-input">
        <button onclick="resetGame()" class="reset-button">Ch∆°i l·∫°i</button>
        
        <div class="bags-container" id="bagsContainer"></div>
    </div>

    <div id="questionModal" class="modal">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <div class="question-card">
                <div class="question-text"></div>
                <div class="options-container"></div>
                <button class="answer-button">Ki·ªÉm tra ƒë√°p √°n</button>
            </div>
            <div class="result-message"></div>
        </div>
    </div>
    <script>
    let questions = [{"question": "C√¢u 1.\tBi·∫øt $\\int\\limits_1^5{f\\left(x\\right)dx}=4$. Gi√° tr·ªã c·ªßa $\\int\\limits_1^5{3f\\left(x\\right)dx}$ b·∫±ng", "options": ["$7$.", "$\\dfrac{4}{5}$.", "$64$.", "$12$."], "correct": 3}, {"question": "C√¢u 2.\tTrong kh√¥ng gian $Oxyz$, h√¨nh chi·∫øu vu√¥ng g√≥c c·ªßa ƒëi·ªÉm $A\\left(1;2;5\\right)$ tr√™n tr·ª•c $Ox$ c√≥ t·ªça ƒë·ªô l√†", "options": ["$\\left(0;2;0\\right)$.", "$\\left(0;0;5\\right)$.", "$\\left(1;0;0\\right)$.", "$\\left(0;2;5\\right)$."], "correct": 2}, {"question": "C√¢u 3.\tCho h√¨nh tr·ª• c√≥ b√°n k√≠nh ƒë√°y $r=4$ v√† ƒë·ªô d√†i ƒë∆∞·ªùng sinh $l=3$. Di·ªán t√≠ch xung quanh c·ªßa h√¨nh tr·ª• ƒë√£ cho b·∫±ng", "options": ["$48\\pi $.", "$12\\pi $.", "$16\\pi $.", "$24\\pi $."], "correct": 3}, {"question": "C√¢u 4.\tTr√™n m·∫∑t ph·∫≥ng t·ªça ƒë·ªô, bi·∫øt $M\\left(-1;3\\right)$ l√† ƒëi·ªÉm bi·ªÉu di·ªÖn c·ªßa s·ªë ph·ª©c $z$. Ph·∫ßn th·ª±c c·ªßa $z$ b·∫±ng", "options": ["$3$.", "$-1$.", "$-3$.", "$1$."], "correct": 1}, {"question": "C√¢u 5.\tC·∫•p s·ªë nh√¢n $\\left({u_n}\\right)$ v·ªõi ${u_1}=2$ v√† c√¥ng b·ªôi $q=3$. Gi√° tr·ªã ${u_2}$", "options": ["$6$.", "$9$.", "$8$.", "$\\dfrac{2}{3}$."], "correct": 0}];
    let gameState = {
        score: 0,
        correctCount: 0,
        totalAnswered: 0,
        openedBags: new Set()
    };

    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            processEscapes: true
        },
        svg: {
            fontCache: 'global'
        }
    };

    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.convertToHtml({arrayBuffer});
            console.log("Converted HTML:", result.value);
            parseQuestions(result.value);
            
            if (questions.length > 0) {
                document.getElementById('totalCount').textContent = questions.length;
                resetGame();
                alert(`ƒê√£ t·∫£i th√†nh c√¥ng ${questions.length} c√¢u h·ªèi!`);
            } else {
                alert('Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong file!');
            }
        } catch (error) {
            console.error("Error:", error);
            alert('L·ªói khi ƒë·ªçc file: ' + error.message);
        }
    }

    function parseQuestions(html) {
        questions = [];
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const paragraphs = doc.body.querySelectorAll('p');
            
            let currentQuestion = null;
            let options = [];
            let correctIndex = -1;

            paragraphs.forEach(p => {
                const text = p.innerHTML.trim();
                let questionMatch = text.match(/C√¢u\s*\d+\s*[.:]/);
                
                if (questionMatch) {
                    if (currentQuestion && options.length === 4 && correctIndex !== -1) {
                        questions.push({
                            question: currentQuestion,
                            options: options,
                            correct: correctIndex
                        });
                    }
                    currentQuestion = text;
                    options = [];
                    correctIndex = -1;
                } else if (currentQuestion) {
                    let optionMatch = text.match(/([A-D])\s*[.)]/);
                    if (optionMatch) {
                        const optionLabel = optionMatch[1];
                        const optionText = text;
                        options.push(optionText);
                        if (text.includes('#')) {
                            correctIndex = optionLabel.charCodeAt(0) - 'A'.charCodeAt(0);
                        }
                    }
                }
            });

            if (currentQuestion && options.length === 4 && correctIndex !== -1) {
                questions.push({
                    question: currentQuestion,
                    options: options,
                    correct: correctIndex
                });
            }
        } catch (error) {
            console.error("Parse error:", error);
            throw error;
        }
    }

    function createBags() {
        const container = document.getElementById('bagsContainer');
        container.innerHTML = '';
        
        for (let i = 0; i < questions.length; i++) {
            const bag = document.createElement('div');
            bag.className = 'question-bag';
            bag.innerHTML = `
                <div class="heart-shape"></div>
                <div class="bag-number">${i + 1}</div>
            `;
            
            bag.onclick = () => {
                if (!gameState.openedBags.has(i)) {
                    openQuestion(i);
                    gameState.openedBags.add(i);
                    bag.style.opacity = '0.6';
                    bag.style.cursor = 'default';
                }
            };
            
            container.appendChild(bag);
        }
        
        updateScoreBoard();
    }

    function openQuestion(index) {
        const questionData = questions[index];
        const modal = document.getElementById('questionModal');
        const questionText = modal.querySelector('.question-text');
        const optionsContainer = modal.querySelector('.options-container');
        const answerButton = modal.querySelector('.answer-button');
        const resultMessage = modal.querySelector('.result-message');
        
        questionText.innerHTML = questionData.question;
        optionsContainer.innerHTML = '';
        resultMessage.style.display = 'none';
        answerButton.disabled = false;
        
        questionData.options.forEach((option, i) => {
            const id = `option-${index}-${i}`;
            optionsContainer.innerHTML += `
                <div class="option-wrapper">
                    <input type="radio" name="answer" value="${i}" id="${id}" class="option-input">
                    <label for="${id}" class="option-label">
                        <div class="option-radio"></div>
                        <div class="option-text">${option}</div>
                    </label>
                </div>
            `;
        });

        answerButton.onclick = () => {
            const selectedOption = modal.querySelector('input[name="answer"]:checked');
            if (!selectedOption) {
                alert('Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n!');
                return;
            }

            const isCorrect = parseInt(selectedOption.value) === questionData.correct;
            
            gameState.score += isCorrect ? 1 : 0;
            gameState.correctCount += isCorrect ? 1 : 0;
            gameState.totalAnswered += 1;

            if (isCorrect) {
                showCorrectAnswer();
                createConfetti();
            } else {
                showIncorrectAnswer();
            }

            answerButton.disabled = true;
            
            const labels = optionsContainer.querySelectorAll('.option-label');
            labels[questionData.correct].style.backgroundColor = '#90EE90';
            
            if (!isCorrect) {
                labels[parseInt(selectedOption.value)].style.backgroundColor = '#FFB6C1';
            }
            
            updateScoreBoard();
        };

        modal.style.display = 'flex';
        MathJax.typesetPromise && MathJax.typesetPromise();
    }

    function showCorrectAnswer() {
        showMessage('result-correct',
            'üéâ',
            'Ch√≠nh x√°c! B·∫°n th·∫≠t xu·∫•t s·∫Øc!<br>H√£y ti·∫øp t·ª•c ph√°t huy nh√©! üåü'
        );
    }

    function showIncorrectAnswer() {
        showMessage('result-incorrect',
            'üòî',
            'R·∫•t ti·∫øc, c√¢u tr·∫£ l·ªùi ch∆∞a ch√≠nh x√°c.<br>ƒê·ª´ng n·∫£n ch√≠, h√£y c·ªë g·∫Øng ·ªü c√¢u ti·∫øp theo nh√©! üí™'
        );
    }

    function showMessage(className, icon, message) {
        const resultMessage = document.querySelector('.result-message');
        resultMessage.className = 'result-message ' + className;
        resultMessage.innerHTML = `
            <div class="result-icon">${icon}</div>
            <div>${message}</div>
        `;
        resultMessage.style.display = 'block';
    }

    function createConfetti() {
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
        
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.animationDelay = Math.random() * 3 + 's';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            document.body.appendChild(confetti);

            setTimeout(() => confetti.remove(), 3000);
        }
    }

    function updateScoreBoard() {
        document.getElementById('score').textContent = gameState.score;
        document.getElementById('correctCount').textContent = gameState.correctCount;
        document.getElementById('totalCount').textContent = gameState.totalAnswered;
    }

    function resetGame() {
        gameState = {
            score: 0,
            correctCount: 0,
            totalAnswered: 0,
            openedBags: new Set()
        };
        questions = questions.sort(() => Math.random() - 0.5);
        createBags();
        updateScoreBoard();
    }

    document.getElementById('fileInput').addEventListener('change', handleFileSelect);

    const modal = document.getElementById('questionModal');
    const closeButton = document.querySelector('.close-button');

    closeButton.onclick = () => modal.style.display = 'none';
    window.onclick = (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };

    // Initialize game
    createBags();
</script>
